# .github/workflows/update_mibgas_data.yml
name: Atualizar Dados MIBGAS Automaticamente

on:
  workflow_dispatch:
  schedule:
    - cron: '55 18 * * *'

permissions:
  contents: write

jobs:
  update-excel-and-push-to-hf:
    runs-on: ubuntu-latest
    steps:
      # ---------------------------------------------------------
      # PASSO 1: Prepara√ß√£o e Execu√ß√£o do Script (Igual ao original)
      # ---------------------------------------------------------
      - name: Checkout do reposit√≥rio GitHub
        uses: actions/checkout@v4

      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar Chrome
        uses: browser-actions/setup-chrome@latest

      - name: Cache depend√™ncias Python
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements_atualizacao_gas_MIBGAS.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Instalar depend√™ncias Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_atualizacao_gas_MIBGAS.txt

      - name: Executar script de atualiza√ß√£o com logging
        run: |
          mkdir -p logs
          start_time=$(date +%s)
          echo "=== Execu√ß√£o iniciada: $(date -d @$start_time '+%Y-%m-%d %H:%M:%S') ===" >> logs/update_mibgas_data.log

          # Executa o script que gera o Excel atualizado na pasta atual
          python scripts/update_mibgas_data.py >> logs/update_mibgas_data.log 2>&1

          end_time=$(date +%s)
          echo "=== Execu√ß√£o terminada: $(date -d @$end_time '+%Y-%m-%d %H:%M:%S') ===" >> logs/update_mibgas_data.log
          echo "Dura√ß√£o: $((end_time-start_time)) segundos" >> logs/update_mibgas_data.log

      # ---------------------------------------------------------
      # PASSO 2: Atualizar o Reposit√≥rio GitHub (Opcional)
      # Se quiseres manter uma c√≥pia no GitHub tamb√©m.
      # ---------------------------------------------------------
      - name: Guardar altera√ß√µes no GitHub (Backup)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Adiciona apenas se houver altera√ß√µes
          git add Tarifarios_üî•_Gas_Natural_Tiago_Felicia.xlsx
          git commit -m "üî• Backup MIBGAS no GitHub" || echo "Sem altera√ß√µes no GitHub"
          git push origin HEAD:main || echo "Nada para fazer push no GitHub"

      # ---------------------------------------------------------
      # PASSO 3: Enviar para o Hugging Face (A Corre√ß√£o)
      # ---------------------------------------------------------
      - name: Enviar ficheiro para o Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # 1. Instalar Git LFS (necess√°rio para ficheiros bin√°rios grandes como Excel)
          sudo apt-get update
          sudo apt-get install git-lfs
          git lfs install

          # 2. Clonar o reposit√≥rio do Hugging Face numa pasta separada 'hf_repo'
          # Usamos a depth 1 para ser mais r√°pido (n√£o baixa o hist√≥rico todo)
          git clone --depth 1 https://user:$HF_TOKEN@huggingface.co/spaces/tiagofelicia/simulador-tarifarios-gas-natural hf_repo

          # 3. Copiar o ficheiro Excel GERADO para a pasta clonada
          # O comando cp -f for√ßa a substitui√ß√£o
          cp -f Tarifarios_üî•_Gas_Natural_Tiago_Felicia.xlsx hf_repo/

          # 4. Entrar na pasta do Hugging Face e fazer o commit
          cd hf_repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Garantir que o Excel √© rastreado pelo LFS (caso n√£o esteja configurado l√°)
          git lfs track "*.xlsx"
          git add .gitattributes
          
          git add Tarifarios_üî•_Gas_Natural_Tiago_Felicia.xlsx
          
          # Commit e Push
          # O "|| echo" impede que o workflow falhe se n√£o houver altera√ß√µes novas
          git commit -m "üî• Atualiza√ß√£o autom√°tica MIBGAS via GitHub Actions" || echo "Sem altera√ß√µes para enviar"
          git push

      # ---------------------------------------------------------
      # PASSO 4: Artefactos de Log
      # ---------------------------------------------------------
      - name: Upload do log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: log_atualizacao_gas_MIBGAS
          path: logs/update_mibgas_data.log
